{% extends "admin/change_form.html" %}

{% block extrahead %}
{{ block.super }}
<style>
  .igdb-lookup {
    margin-bottom: 20px;
    padding: 10px;
    background: var(--darkened-bg);
    border: 1px solid var(--hairline-color);
  }
  .igdb-lookup h3 {
    margin: 0 0 10px 0;
    padding: 8px 10px;
    font-size: 0.8125rem;
    font-weight: bold;
    text-transform: uppercase;
    background: var(--primary);
    color: var(--header-link-color);
  }
  .igdb-search-form {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    padding: 0 10px;
  }
  .igdb-search-form input[type="text"] {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.875rem;
  }
  .igdb-search-form button {
    padding: 6px 15px;
    background: var(--primary);
    color: var(--header-link-color);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8125rem;
    text-transform: uppercase;
  }
  .igdb-search-form button:hover {
    background: var(--primary-fg);
  }
  .igdb-results {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 0 10px;
  }
  .igdb-results:empty {
    display: none;
  }
  .igdb-result {
    display: flex;
    gap: 10px;
    padding: 10px;
    background: var(--body-bg);
    border: 1px solid var(--hairline-color);
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  .igdb-result:hover {
    border-color: var(--primary);
    background: var(--darkened-bg);
  }
  .igdb-result img {
    width: 50px;
    height: 67px;
    object-fit: cover;
    background: var(--darkened-bg);
  }
  .igdb-result-info {
    flex: 1;
    min-width: 0;
  }
  .igdb-result-info h4 {
    margin: 0 0 4px 0;
    font-size: 0.875rem;
    color: var(--body-fg);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .igdb-result-info p {
    margin: 0;
    font-size: 0.75rem;
    color: var(--body-quiet-color);
  }
  .igdb-loading, .igdb-message {
    text-align: center;
    padding: 20px 10px;
    color: var(--body-quiet-color);
    font-size: 0.875rem;
  }
  .igdb-message.success {
    color: var(--close-button-bg);
  }
</style>
{% endblock %}

{% block content %}
<div class="igdb-lookup">
  <h3>IGDB Lookup</h3>
  <div class="igdb-search-form">
    <input type="text" id="igdb-search-input" placeholder="Search for a game on IGDB...">
    <button type="button" id="igdb-search-btn">Search</button>
  </div>
  <div id="igdb-results" class="igdb-results"></div>
</div>

{{ block.super }}

<script>
(function() {
  const searchInput = document.getElementById('igdb-search-input');
  const searchBtn = document.getElementById('igdb-search-btn');
  const resultsContainer = document.getElementById('igdb-results');

  async function searchIGDB(query) {
    resultsContainer.innerHTML = '<div class="igdb-loading">Searching IGDB...</div>';

    try {
      const response = await fetch(`/api/igdb/search?q=${encodeURIComponent(query)}`);
      const data = await response.json();

      if (data.results.length === 0) {
        resultsContainer.innerHTML = '<p>No results found.</p>';
        return;
      }

      resultsContainer.innerHTML = data.results.map(game => `
        <div class="igdb-result" data-game='${JSON.stringify(game)}'>
          <img src="${game.cover_url || '/static/admin/img/icon-no.svg'}" alt="${game.name}">
          <div class="igdb-result-info">
            <h4>${game.name}</h4>
            <p>${game.release_date || 'Unknown release date'}</p>
            <p style="font-size: 11px; color: #999;">IGDB ID: ${game.igdb_id}</p>
          </div>
        </div>
      `).join('');

      // Add click handlers
      document.querySelectorAll('.igdb-result').forEach(el => {
        el.addEventListener('click', () => {
          const game = JSON.parse(el.dataset.game);
          populateForm(game);
        });
      });
    } catch (error) {
      resultsContainer.innerHTML = `<p>Error: ${error.message}</p>`;
    }
  }

  function populateForm(game) {
    // Populate form fields
    const fields = {
      'id_name': game.name,
      'id_slug': game.slug,
      'id_igdb_id': game.igdb_id,
      'id_cover_url': game.cover_url || '',
      'id_release_date': game.release_date || '',
      'id_summary': game.summary || '',
    };

    for (const [fieldId, value] of Object.entries(fields)) {
      const field = document.getElementById(fieldId);
      if (field) {
        field.value = value;
        // Trigger change event for any listeners
        field.dispatchEvent(new Event('change'));
      }
    }

    // Clear results and show success message
    resultsContainer.innerHTML = `<div class="igdb-message success">âœ“ Populated form with "${game.name}"</div>`;
  }

  searchBtn.addEventListener('click', () => {
    const query = searchInput.value.trim();
    if (query) {
      searchIGDB(query);
    }
  });

  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query) {
        searchIGDB(query);
      }
    }
  });
})();
</script>
{% endblock %}
